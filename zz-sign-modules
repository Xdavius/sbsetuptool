#!/bin/sh

KERNEL_VERSION="${1:-$(uname -r)}"
KEYDIR="/usr/share/secureboot-signing"
SIGN_FILE="/usr/src/linux-headers-${KERNEL_VERSION}/scripts/sign-file"

RED='\033[0;31m'
YELLOW='\033[1;33m'
ORANGE='\033[38;5;208m'
GREEN='\033[0;32m'
RESET='\033[0m'

if [ ! -x "$SIGN_FILE" ]; then
	printf "${RED}[!] Fichier sign-file introuvable ou non exécutable : $SIGN_FILE${RESET}\n"
	printf "${RESET}\n"
	exit 1
fi

printf "${YELLOW}[I] Signature des modules du noyau ${KERNEL_VERSION}${RESET}\n"
printf "${RESET}\n"
if [ -d "/usr/lib/modules/${KERNEL_VERSION}" ]; then
	find "/usr/lib/modules/${KERNEL_VERSION}/" -name '*.ko' | while read -r module; do
		"$SIGN_FILE" sha256 "$KEYDIR/MOK.priv" "$KEYDIR/MOK.der" "$module" || {
			printf "${RED}[!] Échec de la signature : $module${RESET}\n"
			printf "${RESET}\n"
			break
		}
	done
	printf "${GREEN}[V] Tous les modules signés avec succès${RESET}\n"
	printf "${RESET}\n"
else
	printf "${YELLOW}[!] Dossier de modules introuvable pour ${KERNEL_VERSION}${RESET}\n"
	printf "${RESET}\n"
fi
